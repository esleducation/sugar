//
// Loaders specific
//

@mixin s-loader-grid(
	$shape : rect,
	$color : s-color(primary),
	$cols : 5,
	$rows : 5,
	$size : 10px,
	$gap : 5px,
	$offset : 200px,
	$rotate : 0deg,
	$a-shape : null,
	$a-steps : 5,
	$a-spread : null,
	$a-rotate : null,
	$a-scale : null,
	$a-opacity : null,
	$a-duration : 1s,
	$a-delay : 0s,
	$a-ease : ease-in-out
) {

	@if $_sugar-test-arguments {
		$shape : s-test-argument('s-loader-grid','shape',(rect,circle),$shape);
		$color : s-test-argument('s-loader-grid','color','color|list-color',$color);
		$cols : s-test-argument('s-loader-grid','cols',integer,$cols);
		$rows : s-test-argument('s-loader-grid','rows',integer,$rows);
		$size : s-test-argument('s-loader-grid','size',number,$size);
		$gap : s-test-argument('s-loader-grid','gap',number,$gap);
		$offset : s-test-argument('s-loader-grid','offset',number,$offset);
		$rotate : s-test-argument('s-loader-grid','rotate',degree,$rotate);
		$a-shape : s-test-argument('s-loader-grid','a-shape',(rect,circle),$a-shape);
		$a-steps : s-test-argument('s-loader-grid','a-steps',integer,$a-steps);
		$a-spread : s-test-argument('s-loader-grid','a-spread',number,$a-spread);
		$a-rotate : s-test-argument('s-loader-grid','a-rotate',degree,$a-rotate);
		$a-scale : s-test-argument('s-loader-grid','a-scale',number,$a-scale);
		$a-opacity : s-test-argument('s-loader-grid','a-opacity',number,$a-opacity);
		$a-duration : s-test-argument('s-loader-grid','a-duration',second,$a-duration);
		$a-delay : s-test-argument('s-loader-grid','a-delay',second,$a-delay);
		$a-ease : s-test-argument('s-loader-grid','a-ease',string,$a-ease);
	}

	// handle colors
	$colors : null;
	@if s-is($color,list-color) and length($color) > 1 {
		$colors : $color;
	}
	
	// manage duration :
	$a-duration : $a-duration + $a-delay;

	width : $size;
	height : $size;
	@if $shape == circle {
		border-radius: 50%;
	}

	// position grid
	$width : $size * $cols + $gap * ($cols - 1);
	$height : $size * $rows + $gap * ($rows - 1);

	// @include s-translate((-$width / 2 - $size - $gap - $offset) (-$height / 2 - $size - $gap - $offset));
	transform:
		translateX(-$width / 2 - $size - $gap - $offset)
		translateY(-$height / 2 - $size - $gap - $offset)
		rotate($rotate);
	transform-origin: ($offset + $width / 2 + $gap + $size) ($offset + $height / 2 + $gap + $size);

	$a-name : unquote("grid-#{unique-id()}");

	// calculate box shadows
	$shadows : ();
	$color-idx : 1;
	@for $i from 0 through $cols - 1 {
		@for $j from 0 through $rows - 1 {
			$x : ($size * $i + $gap * $i) + $size + $gap + $offset;
			$y : ($size * $j + $gap * $j) + $size + $gap + $offset;
			$c : $color;
			@if $colors and length($colors) == $cols * $rows {
				$c : nth($colors, $color-idx);
				$color-idx : $color-idx + 1;
			} @else if length($colors) == 2 {
				@if $j % 2 == 0 {
					$color-idx : $color-idx - 1;
				}
				$c : nth($colors, $color-idx % 2 + 1);
			}
			$shadows : append($shadows, $c $x $y 0 0, comma);
		}
	}

	&:before {
		@if $shape == circle {
			border-radius: 50%;
		}
		position: relative;
		z-index:1;
		content:'';
		display: block;
		width: $size;
		height: $size;
		animation : $a-name $a-duration $a-ease 0s infinite;
		box-shadow : $shadows;
		transform-origin: ($offset + $width / 2 + $gap + $size) ($offset + $height / 2 + $gap + $size);
	}

	// calculate percentage of delay
	$p-delay : 1 / $a-duration * $a-delay;
	// animation
	@keyframes #{$a-name} {
		@for $i from 1 through $a-steps {
			$percentage : percentage((1 - $p-delay) / $a-steps * $i);
			#{$percentage} {
				// loop on each box shadows
				$shadows : ();
				$color-idx : 1;
				@for $j from 0 through $cols - 1 {
					@for $k from 0 through $rows - 1 {
						$x : ($size * $j + $gap * $j) + $size + $gap + $offset;
						$y : ($size * $k + $gap * $k) + $size + $gap + $offset;
						$s-spread : 0;
						$blur : 0;
						$c : $color;
						@if $colors and length($colors) == $cols * $rows {
							$c : nth($colors, $color-idx);
							$color-idx : $color-idx + 1;
						} @else if length($colors) == 2 {
							@if $j % 2 != 0 {
								$color-idx : $color-idx - 1;
							}
							$c : nth($colors, $color-idx % 2 + 1);
						}
						$transparentize : 0;
						@if $a-opacity and $i < $a-steps {
							$transparentize : 1 - $a-opacity;
							$transparentize : $transparentize * 10;
							$t-rand : random($transparentize);
							$transparentize : $t-rand / 10;
							$c : transparentize($c, $transparentize);
						}
						@if $a-scale {
							@if $i >= $a-steps {
								$s-spread : 0;
							} @else {
								$s-spread : s-rem(random($a-scale - $size) + 0px);
							}
						}
						@if $a-spread and $i < $a-steps {
							$randX : random($a-spread / 2);
							$randY : random($a-spread / 2);
							@if random(10) < 5 {
								$randX : $randX * -1;
							}
							@if random(10) < 5 {
								$randY : $randY * -1;
							}
							$x : $x + $randX;
							$y : $y + $randY;
						}
						@if $i >= $a-steps {
							$shadows : append($shadows, $c $x $y 0 0, comma);
						} @else {
							$shadows : append($shadows, $c $x $y $blur $s-spread, comma);
						}
					}
				}
				@if $a-rotate and $i < $a-steps {

					$randX : random($a-rotate / 2);
					@if random(10) < 5 {
						$randX : $randX * -1;
					}
					transform : rotateZ($randX + 0deg);
				} @else {
					transform : rotateZ(0);
				}
				@if $i < $a-steps - 1 {
					@if $a-shape == circle {
						@include s-corner(50%);
					} @else if $a-shape == rect {
						@include s-corner(0);
					}
				}
				// apply shadows
				box-shadow: $shadows;
			}
		}
	}
}

@mixin s-loader-spinner(
	$type : linear,
	$size : 1em,
	$width : 0.3em,
	$color : s-color(primary),
	$bgcolor : inherit,
	$length : 3/4,
	$a-duration : 1s,
	$a-ease : null
) {	
	@if $_sugar-test-arguments {
		$type : s-test-argument('s-loader-spinner','type',(elastic,linear,fade-in,fade-out,fade-in-out),$type);
		$size : s-test-argument('s-loader-spinner','size',number,$size);
		$width : s-test-argument('s-loader-spinner','width',number,$width);
		$color : s-test-argument('s-loader-spinner','color',color,$color);
		@if $bgcolor != inherit {
			$bgcolor : s-test-argument('s-loader-spinner','bgcolor',color,$bgcolor);
		}
		$length : s-test-argument('s-loader-spinner','length',number,$length);
		$a-duration : s-test-argument('s-loader-spinner','a-duration',second,$a-duration);
		$a-ease : s-test-argument('s-loader-spinner','a-ease',string,$a-ease);
	}

	@if $type == elastic and not $a-ease {
		$a-ease : ease;
	} @else if not $a-ease {
		$a-ease : linear;
	}

	$a-name : unquote("spinner-#{unique-id()}");
	$p-step : 1 / $a-duration;

	@if $type == linear {
		& {
			font-size:$size;
			position:relative;
			text-indent:-9999em;
			border-top:$width solid transparentize($color,.8);
			border-right:$width solid transparentize($color,.8);
			border-bottom:$width solid transparentize($color,.8);
			border-left:$width solid transparentize($color,0);
			transform: translateZ(0);
			animation: $a-name $a-duration $a-ease 0s infinite;
		}
		&,&:after {
			border-radius:50%;
			width:1em;
			height:1em;
		}
		@keyframes #{$a-name} {
			0% {
				transform:rotate(0deg);
			}
			100% {
				transform:rotate(360deg);
			}
		}
	} @else if $type == elastic {
		background: inherit;
		&,&:before,&:after {
			border-radius:50%;
		}
		&:before,&:after {
			position:absolute;
			content:'';
		}
		&:before {
			width:5.2em;
			height:10.2em;
			background: $bgcolor;
			border-radius: 10.2em 0 0 10.2em;
			top:-0.1em;
			left:-0.1em;
			transform-origin:5.2em 5.1em;
			animation:$a-name $a-duration infinite $a-ease $a-duration * $length;
		}
		& {
			font-size:$size / 10;
			text-indent:-99999em;
			position:relative;
			width:10em;
			height:10em;
			box-shadow: inset 0 0 0 $width $color;
			transform: translateZ(0);
		}
		&:after {
			width:5.2em;
			height:10.2em;
			background: $bgcolor;
			border-radius: 0 10.2em 10.2em 0;
			top:-0.1em;
			left:5.1em;
			transform-origin:0px 5.1em;
			animation:$a-name $a-duration infinite ease;
		}
		@keyframes #{$a-name} {
			0% {
				transform:rotate(0deg);
			}
			100% {
				transform:rotate(360deg);
			}
		}
	} @else if $type == fade-out {
		& {
			font-size:$size;
			text-indent:-9999em;
			width:1em;
			height:1em;
			border-radius:50%;
			background: $color;
			background: linear-gradient(to right, transparentize($color,0) 10%, transparentize($color,1) 42%);
			position: relative;
			animation: $a-name $a-duration $a-ease 0s infinite;
			transform: translateZ(0);
		}
		&:before {
			width:50%;
			height:50%;
			background: $color;
			border-radius: 100% 0 0 0;
			position:absolute;
			top:0;
			left:0;
			content:'';
		}
		$width : $size - $width * 2;
		&:after {
			background:$bgcolor;
			width: $width;
			height: $width;
			border-radius:50%;
			content:'';
			margin:auto;
			position: absolute;
			top: 0; left: 0; bottom: 0; right: 0;
		}
		@keyframes #{$a-name} {
			0% {
				transform:rotate(0deg);
			}
			100% {
				transform:rotate(360deg);
			}
		}
	} @else if $type == fade-in {
		& {
			font-size:$size;
			text-indent:-9999em;
			width:1em;
			height:1em;
			border-radius:50%;
			background: $color;
			background: linear-gradient(to left, transparentize($color,1) 52%, transparentize($color,0) 90%);
			position: relative;
			animation: $a-name $a-duration $a-ease 0s infinite;
			transform: translateZ(0);
		}
		&:before {
			width:50%;
			height:50%;
			background: $color;
			border-radius: 0 0 0 100%;
			position:absolute;
			bottom:0;
			left:0;
			content:'';
		}
		$width : $size - $width * 2;
		&:after {
			background:$bgcolor;
			width: $width;
			height: $width;
			border-radius:50%;
			content:'';
			margin:auto;
			position: absolute;
			top: 0; left: 0; bottom: 0; right: 0;
		}
		@keyframes #{$a-name} {
			0% {
				transform:rotate(0deg);
			}
			100% {
				transform:rotate(360deg);
			}
		}
	} @else if $type == fade-in-out {
		font-size: $size;
		width: 1em;
		height: 1em;
		border-radius: 50%;
		//overflow: hidden;
		&:before {
			content: "";
			position: absolute;
			width: 100%;
			height: 100%;
			border-radius: 50%;
			background: linear-gradient($color, transparentize($color,1) 60%);
			animation: $a-name $a-duration infinite linear;
		}
		$width : $size - $width * 2;
		&:after {
			background:$bgcolor;
			width: $width;
			height: $width;
			border-radius:50%;
			content:'';
			margin:auto;
			position: absolute;
			top: 0; left: 0; bottom: 0; right: 0;
		}
		@keyframes #{$a-name} {
			to {
				transform: rotate(360deg);
			}
		}
	}
}

@mixin s-loader-circle(
	$color : s-color(primary),
	$size : 10px,
	$radius : 30px,
	$count : 8,
	$opacity : 1,
	$a-spread : null,
	$a-rotate : null,
	$a-scale : null,
	$a-opacity : null,
	$a-near : null,
	$a-ease : ease-in-out,
	$a-duration : 1s,
	$a-delay : 0s
) {
	@if $_sugar-test-arguments {
		$color : s-test-argument('s-loader-circle','color','color|list-color',$color);
		$size : s-test-argument('s-loader-circle','size',number,$size);
		$radius : s-test-argument('s-loader-circle','radius',number,$radius);
		$count : s-test-argument('s-loader-circle','count',integer,$count);
		$opacity : s-test-argument('s-loader-circle','opacity',number,$opacity);
		$a-spread : s-test-argument('s-loader-circle','a-spread',number,$a-spread);
		$a-rotate : s-test-argument('s-loader-circle','a-rotate',degree,$a-rotate);
		$a-scale : s-test-argument('s-loader-circle','a-scale',number,$a-scale);
		$a-opacity : s-test-argument('s-loader-circle','a-opacity',number,$a-opacity);
		$a-near : s-test-argument('s-loader-circle','a-near',number,$a-near);
		$a-ease : s-test-argument('s-loader-circle','a-ease',string,$a-ease);
		$a-duration : s-test-argument('s-loader-circle','a-duration',second,$a-duration);
		$a-delay : s-test-argument('s-loader-circle','a-delay',second,$a-delay);
	}
	
	// handle colors
	$colors : null;
	@if s-is($color,list-color) and length($color) > 1 {
		$colors : $color;
	}

	// manage near
	@if not $a-near {
		$a-near : $count / 2;
	}
	
	$a-name : unquote("circle-#{unique-id()}");
	// manage duration
	$a-duration : $a-duration + $a-delay;

	$base-shadows : ();
	@for $i from 0 through $count {
		$x : $radius * s-cos(360deg / $count * $i);
		$y : $radius * s-sin(360deg / $count * $i);
		$c : $color;
		@if $colors {
			$c : nth($colors, $i + 1);
		}
		@if $opacity {
			$c : transparentize($c, 1 - $opacity);
		}
		$base-shadows : append($base-shadows, $c $x $y 0 0, comma);	
	}

	$spread-map : ();
	// calculate percentage of delay
	$p-delay : 0;
	$p-step : 1 / $count;
	@if $a-delay > 0 {
		$p-delay : 1 / $a-duration * $a-delay;
		$p-step : (1 - $p-delay) / ($count + 1);
	}
	// animation
	@keyframes #{$a-name} {
		@for $step-idx from 0 through $count {
			$p : percentage($step-idx * $p-step);
			@if $a-delay > 0 {
				$p : percentage($step-idx * $p-step) + percentage($p-step);
			}
			#{$p} {
				$shadows : ();
				@for $count-idx from 0 through $count {
					$x : $radius * s-cos(360deg / $count * $count-idx);
					$y : $radius * s-sin(360deg / $count * $count-idx);
					
					$diff : abs($step-idx - $count-idx);
					@if $step-idx + $a-near > $count and $count-idx - $a-near < 0 {
						$diff : abs($count-idx - ($step-idx - $count));
					} @else if $step-idx - $a-near < 0 and $count-idx + $a-near > $count {
						$diff : abs($step-idx + ($count - $count-idx));
					}

					$c : $color;
					@if $colors {
						$c : nth($colors, $count-idx + 1);
					}
					$_opacity : 1;
					@if $a-opacity {
						@if $diff < $a-near {
							$_opacity : ($a-opacity - $opacity) / $a-near * ($a-near - $diff);
							$o : $opacity + $_opacity;
							// $transparentize : $_opacity;
							$c : transparentize($c, 1 - $o);
						} @else if $opacity {
							$c : transparentize($c, 1 - $opacity);
						}					
					} @else if $opacity {
						$c : transparentize($c, 1 - $opacity);
					}
					$scale : $size;
					@if $a-scale {
						@if $diff == 0 {
							$scale : $a-scale;
						} @else if $diff <= $a-near {
							$s : $a-scale - $size;
							$scale : $size + $s - $s / $a-near * $diff;
						}
					}
					@if $a-spread and $diff < $a-near {
						$randX : random(round($a-spread / 2));
						$randY : random(round($a-spread / 2));
						@if random(10) < 5 {
							$randX : $randX * -1;
						}
						@if random(10) < 5 {
							$randY : $randY * -1;
						}
						@if $step-idx == 0 {
							$s : (
								x : $randX,
								y : $randY
							);
							$spread-map : map-set($spread-map, $count-idx, $s);
						}
						@if $step-idx == $count {
							$map : map-get($spread-map, $count-idx);
							@if $map {
								$randX : map-get($map, x);
								$randY : map-get($map, y);
							} @else {
								$randX : 0;
								$randY : 0;
							}
						}
						$x : $x + $randX;
						$y : $y + $randY;
					}
					@if $count-idx < $count {
						$shadows : append($shadows, $x $y 0 ($scale - $size) $c, comma);
					}
				}
				box-shadow : $shadows;
			}
		}
		@if $a-delay > 0 and percentage($count * $p-step) + percentage($p-step) < 100 {
			#{percentage($count * $p-step) + percentage($p-step) * 2} {
				box-shadow: $base-shadows;
			}
		}
	}
	&:after {
		border-radius:50%;
		width : $size;
		height : $size;
		display : block;
		content : '';
		box-shadow: $base-shadows;
		animation : $a-name $a-duration $a-ease 0s infinite;
	}
	// @include s-translate(-50% -50%);
	// transform: rotate(- 360deg / $count / 2);
	transform : translateX(-50%) translateY(-50%) rotate(-90deg);
}

@mixin s-loader-radial(
	$shape : circle,
	$size : 1em,
	$width : 0.2em,
	$style : solid,
	$color : s-color(primary),
	$a-duration : 2s,
	$a-delay : 0s,
	$a-count : 2,
	$a-spread : 0,
	$a-ease : linear
) {
	@if $_sugar-test-arguments {
		$shape : s-test-argument('s-loader-radial','shape',(circle,rect),$shape);
		$size : s-test-argument('s-loader-radial','size',number,$size);
		$width : s-test-argument('s-loader-radial','width',number,$width);
		$style : s-test-argument('s-loader-radial','style',(none,hidden,dotted,dashed,solid,double,groove,ridge,inset,outset,initial,inherit),$style);
		$color : s-test-argument('s-loader-radial','color','color|list-color',$color);
		$a-duration : s-test-argument('s-loader-radial','a-duration',second,$a-duration);
		$a-delay : s-test-argument('s-loader-radial','a-delay',second,$a-delay);
		$a-count : s-test-argument('s-loader-radial','a-count',integer,$a-count);
		$a-spread : s-test-argument('s-loader-radial','a-spread',number,$a-spread);
		$a-ease : s-test-argument('s-loader-radial','a-ease',string,$a-ease);
	}

	// handle colors
	$colors : null;
	@if s-is($color,list-color) and length($color) > 1 {
		$colors : $color;
	}

	// manage duration
	$a-duration : $a-duration + $a-delay;

	// calculate percentage of delay
	$p-delay : 1;
	@if $a-delay > 0 {
		$p-delay : 1 - 1 / $a-duration * $a-delay;
	}

	$a-name : unquote("radial-#{unique-id()}");
	$step : percentage($p-delay / $a-count);
	$current : 0%;
	$current-idx : 1;
	@keyframes #{$a-name}-b {
		@for $i from 0 through $a-count - 1 {
			@if $current < 100 {
				#{$current} {
					transform:translateX(-50%) translateY(-50%) scaleX(0) scaleY(0);
					opacity:0;
					top : 0;
					left : 0;
					@if $colors and length($colors) == $a-count * 2 {
						$c : nth($colors, $current-idx);
						border-color: $c;
						// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
					}
				}
				#{$current + $step / 2 - 0.0001%} {
					transform: translateX(-50%) translateY(-50%) scaleX(0.5) scaleY(0.5);
					opacity:1;
					@if $colors and length($colors) == $a-count * 2 {
						$c : nth($colors, $current-idx);
						border-color: $c;
						// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
					}
				}
				#{$current + $step - 0.0001%} {
					transform: translateX(-50%) translateY(-50%) scaleX(1) scaleY(1);
					opacity:0;
					@if $a-spread > 0 {
						$randX : random(round($a-spread));
						@if random(10) < 5 {
							$randX : $randX * -1;
						}
						$randY : random(round($a-spread));
						@if random(10) < 5 {
							$randY : $randY * -1;
						}
						top : $randY + unquote(unit($a-spread));
						left : $randX + unquote(unit($a-spread));
					}
					@if $colors and length($colors) == $a-count * 2 {
						$c : nth($colors, $current-idx);
						border-color: $c;
						// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
					}
				}
				#{$current + $step} {
					transform : translateX(-50%) translateY(-50%) scaleX(0) scaleY(0);
					top: 0;
					left: 0;
				}
			}
			$current : $current + $step;
			$current-idx : $current-idx + 2;
		}
	}
	$current : 0%;
	$current-idx : 2;
	@keyframes #{$a-name}-a {
		@for $i from 0 through $a-count - 1 {
			@if $current < 100 {
				#{$current} {
					transform : translateX(-50%) translateY(-50%) scaleX(0) scaleY(0);
					opacity:0;
					top : 0;
					left : 0;
					@if $colors and length($colors) == $a-count * 2 {
						$c : nth($colors, $current-idx);
						border-color: $c;
						//background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
					}
				}
				#{$current + $step / 2 - 0.0001%} {
					transform : translateX(-50%) translateY(-50%) scaleX(0.5) scaleY(0.5);
					opacity:1;
					@if $colors and length($colors) == $a-count * 2 {
						$c : nth($colors, $current-idx);
						border-color: $c;
						// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
					}
				}
				#{$current + $step - 0.0001%} {
					transform : translateX(-50%) translateY(-50%) scaleX(1) scaleY(1);
					opacity:0;
					@if $a-spread > 0 {
						$randX : random(round($a-spread));
						@if random(10) < 5 {
							$randX : $randX * -1;
						}
						$randY : random(round($a-spread));
						@if random(10) < 5 {
							$randY : $randY * -1;
						}
						top : $randY + unquote(unit($a-spread));
						left : $randX + unquote(unit($a-spread));
					}
					@if $colors and length($colors) == $a-count * 2 {
						$c : nth($colors, $current-idx);
						// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
						border-color : $c;
					}
				}
				#{$current + $step} {
					transform : translateX(-50%) translateY(-50%) scaleX(0) scaleY(0);
					top: 0;
					left: 0;
				}
			}
			$current : $current + $step;
			$current-idx : $current-idx + 2;
		}
	}
	
	position: relative;
	&:before,
	&:after {
		content:'';
		display: block;
		width:$size;
		height:$size;
		position: absolute;
		top:0; left:0;
		@include s-translate(-50%, -50%);
		opacity:0;
		@if $shape == circle {
			border-radius:50%;
		}
	}
	// cubic-bezier(1,.01,0,1)
	$c : $color;
	@if $colors and length($colors) >= 2 {
		$c : nth($colors, 1);
	}
	&:before {
		border:$width $style $c;
		// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
		animation: #{$a-name}-b $a-duration $a-ease 0s infinite;
	}
	@if $colors and length($colors) >= 2 {
		$c : nth($colors, 2);
	}
	&:after {
		border: $width $style $c;
		// background: radial-gradient(transparentize($c, 1) 30%, $c 50%, transparentize($c, 1) 70%);
		animation: #{$a-name}-a $a-duration $a-ease ($a-duration - $a-delay) / $a-count / 2 infinite;
	}
}

@mixin s-loader-bars(
	$shape : rect,
	$color : s-color(primary),
	$width : 0.5em,
	$height : 2em,
	$count : 5,
	$gap : 0.5em,
	$opacity : 1,
	$a-opacity : null,
	$a-duration : 1s,
	$a-delay : 0s,
	$a-near : 1,
	$a-ease : ease-in-out,
	$a-spread : null,
	$a-direction : both,
	$a-continuous : true
) {
	@if $_sugar-test-arguments {
		$shape : s-test-argument('s-loader-bars','shape',(circle,rect),$shape);
		$color : s-test-argument('s-loader-bars','color','color|list-color',$color);
		$width : s-test-argument('s-loader-bars','width',number,$width);
		$height : s-test-argument('s-loader-bars','height',number,$height);
		$count : s-test-argument('s-loader-bars','count',integer,$count);
		$gap : s-test-argument('s-loader-bars','gap',number,$gap);
		$opacity : s-test-argument('s-loader-bars','opacity',number,$opacity);
		$a-opacity : s-test-argument('s-loader-bars','a-opacity',number,$a-opacity);
		$a-duration : s-test-argument('s-loader-bars','a-duration',second,$a-duration);
		$a-delay : s-test-argument('s-loader-bars','a-delay',second,$a-delay);
		$a-near : s-test-argument('s-loader-bars','a-near',integer,$a-near);
		$a-ease : s-test-argument('s-loader-bars','a-ease',string,$a-ease);
		$a-direction : s-test-argument('s-loader-bars','a-direction',(up,down,both),$a-direction);
		$a-continuous : s-test-argument('s-loader-bars','a-continuous',boolean,$a-continuous);
	}
	
	// handle colors
	$colors : null;
	@if s-is($color,list-color) and length($color) > 1 {
		$colors : $color;
	}

	// manage duration
	$a-duration : $a-duration + $a-delay;
	@if $a-delay > 0 {
		$a-continuous : false;
	}

	// manage direction
	@if not $a-spread or $a-spread <= 0 {
		$a-direction : up;
	}

	$offset : $width;

	// position grid
	$_width : $width * ($count - 1) + $gap * ($count - 1);

	$a-name : unquote("bars-#{unique-id()}");

	// calculate box shadows
	$shadows : ();
	
	@if $a-direction == both or $a-direction == up {
		@for $i from 0 through $count - 1 {
			$x : ($width * $i + $gap * $i) + $width + $gap + $offset;
			$y : $height / 2 + $offset;
			$c : $color;
			@if $colors {
				$c : nth($colors, $i + 1);
			}
			@if $a-opacity {
				$c : transparentize($color, 1 - $opacity);
			}
			$shadows : append($shadows, $c $x $y 0 0, comma);
		}
	}
	@if $a-direction == both or $a-direction == down {
		@for $i from 0 through $count - 1 {
			$x : ($width * $i + $gap * $i) + $width + $gap + $offset;
			$y : $height / 2 + $offset;
			$c : $color;
			@if $colors {
				$c : nth($colors, $i + 1);
			}
			@if $a-opacity {
				$c : transparentize($color, 1 - $opacity);
			}
			$shadows : append($shadows, $c $x $y 0 0, comma);
		}
	}
	$base-shadows : $shadows;

	&:before {
		@if $shape == circle {
			border-radius: 50%;
		}
		width: $width;
		height: $height;
		content: '';
		display: block;
		animation : $a-name $a-duration $a-ease 0s infinite;
		box-shadow : $shadows;
		@include s-translate((-$_width / 2 - $width - $gap - $offset), (-$height / 2 - $offset));
		transform-origin: ($offset + $_width / 2 + $gap + $width) ($offset + $height / 2);
	}

	// calculate percentage of delay
	$p-delay : 0;
	$p-step : 1 / $count;
	@if $a-delay > 0 {
		$p-delay : 1 / $a-duration * $a-delay;
		$p-step : (1 - $p-delay) / ($count + 1);
	}
	// animation
	$step : 1 / $count;
	@keyframes #{$a-name} {
		@for $j from 0 through $count {
			$p : percentage($j * $p-step);
			@if $a-delay > 0 {
				$p : percentage($j * $p-step) + percentage($p-step);
			}
			#{$p} {
				// loop on each box shadows
				$shadows : ();

				@if $a-direction == both or $a-direction == up {
					@for $i from 0 through $count - 1 {
						$x : ($width * $i + $gap * $i) + $width + $gap + $offset;
						$y : $height / 2 + $offset;
						
						$diff : abs($j - $i);

						@if $a-continuous {
							@if $j + $a-near > $count and $i - $a-near < 0 {
								$diff : abs($i - ($j - $count));
							} @else if $j - $a-near < 0 and $i + $a-near > $count {
								$diff : abs($j + ($count - $i));
							}
						}

						@if $a-spread {
							@if $diff < $a-near {
								$y : $y - ($a-spread - ($a-spread / $a-near * $diff));
							} @else if $i == $j {
								$y : $y - $a-spread;
							}
						}
						
						$c : $color;
						@if $colors {
							$c : nth($colors, $i + 1);
						}
						$_opacity : 1;
						@if $a-opacity {
							@if $diff < $a-near {
								$_opacity : ($a-opacity - $opacity) / $a-near * ($a-near - $diff);
								$o : $opacity + $_opacity;
								// $transparentize : $_opacity;
								$c : transparentize($c, 1 - $o);
							} @else if $opacity {
								$c : transparentize($c, 1 - $opacity);
							}					
						} @else if $opacity {
							$c : transparentize($c, 1 - $opacity);
						}
						$shadows : append($shadows, $c $x $y 0 0, comma);
					}
				}

				@if $a-direction == both or $a-direction == down {
					@for $i from 0 through $count - 1 {
						$x : ($width * $i + $gap * $i) + $width + $gap + $offset;
						$y : $height / 2 + $offset;
						
						$diff : abs($j - $i);
						@if $a-continuous {
							@if $j + $a-near > $count and $i - $a-near < 0 {
								$diff : abs($i - ($j - $count));
							} @else if $j - $a-near < 0 and $i + $a-near > $count {
								$diff : abs($j + ($count - $i));
							}
						}

						@if $diff < $a-near {
							$y : $y + ($a-spread - ($a-spread / $a-near * $diff));
						} @else if $i == $j {
							$y : $y + $a-spread;
						}
						$c : $color;
						@if $colors {
							$c : nth($colors, $i + 1);
						}
						$_opacity : 1;
						@if $a-opacity {
							@if $diff < $a-near {
								$_opacity : ($a-opacity - $opacity) / $a-near * ($a-near - $diff);
								$o : $opacity + $_opacity;
								// $transparentize : $_opacity;
								$c : transparentize($c, 1 - $o);
							} @else if $opacity {
								$c : transparentize($c, 1 - $opacity);
							}					
						} @else if $opacity {
							$c : transparentize($c, 1 - $opacity);
						}
						$shadows : append($shadows, $c $x $y 0 0, comma);
					}
				}

				// apply shadows
				box-shadow: $shadows;
			}
		}
		@if $a-delay > 0 and percentage($count * $p-step) + percentage($p-step) < 100 {
			#{percentage($count * $p-step) + percentage($p-step) * 2} {
				box-shadow: $base-shadows;
			}
		}
	}
}

@mixin s-loader-couch-potato(
	$size : 1em,
	$color : s-color(primary),
	$a-duration : 1s,
	$a-delay : 0s,
	$a-ease : ease-in-out,
	$a-rotate : 360deg,
	$a-scale : 0.7
) {
	@if $_sugar-test-arguments {
		$size : s-test-argument('s-loader-couch-potato','size',number,$size);
		$color : s-test-argument('s-loader-couch-potato','color','color|list-color',$color);
		$a-duration : s-test-argument('s-loader-couch-potato','a-duration',second,$a-duration);
		$a-delay : s-test-argument('s-loader-couch-potato','a-delay',second,$a-delay);
		$a-ease : s-test-argument('s-loader-couch-potato','a-ease',string,$a-ease);
		$a-rotate : s-test-argument('s-loader-couch-potato','a-rotate',degree,$a-rotate);
		$a-scale : s-test-argument('s-loader-couch-potato','a-scale',number,$a-scale);
	}
	
	// handle colors
	$colors : null;
	@if s-is($color,list-color) and length($color) > 1 {
		$colors : $color;
	}

	$a-duration : $a-duration + $a-delay;

	$a-name : unquote("couch-potato-#{unique-id()}");
	
	$c : $color;
	@if $colors and length($colors) == 2 {
		$c : nth($colors, 1);
	}
	&:before {
		display: block;
		width : $size;
		height: $size;
		content:'';
		@include s-translate(-50%, -50%);
		background: $c;
		transform-origin: $size/2 $size/2;
		animation: $a-name $a-duration $a-ease 0s infinite;
	}
	
	$p-delay : 0;
	@if $a-delay > 0 {
		$p-delay : 1 / $a-duration * $a-delay;
	}
	@keyframes #{$a-name} {
		0% {
			border-radius:0;
			transform : rotate(0deg) scale(1);
		}
		#{(100% - percentage($p-delay)) / 2} {
			border-radius:50%;
			transform : rotate($a-rotate / 2) scale($a-scale);
			@if $colors and length($colors) == 2 {
				$c : nth($colors, 2);
			}
			background: $c;
		}
		#{100% - percentage($p-delay)} {
			border-radius:0;
			transform : rotate($a-rotate) scale(1);
			@if $colors and length($colors) == 2 {
				$c : nth($colors, 1);
			}
			background: $c;
		}
		100% {
			border-radius:0;
			transform : rotate($a-rotate) scale(1);
		}
	}
}

@mixin s-loader-flip-ball(
	$shape : circle,
	$size : 1em,
	$color : s-color(primary),
	$a-duration : 1s,
	$a-delay : 0s,
	$a-ease : ease-in-out
) {
	@if $_sugar-test-arguments {
		$shape : s-test-argument('s-loader-flip-ball','shape',(circle,rect),$shape);
		$size : s-test-argument('s-loader-flip-ball','size',number,$size);
		$color : s-test-argument('s-loader-flip-ball','color','color|list-color',$color);
		$a-duration : s-test-argument('s-loader-flip-ball','a-duration',second,$a-duration);
		$a-delay : s-test-argument('s-loader-flip-ball','a-delay',second,$a-delay);
		$a-ease : s-test-argument('s-loader-flip-ball','a-ease',string,$a-ease);
	}

	// handle colors
	$colors : null;
	@if s-is($color,list-color) and length($color) > 1 {
		$colors : $color;
	}

	$a-duration : $a-duration + $a-delay;

	$a-name : unquote("google-ball-#{unique-id()}");
	
	$c : $color;
	@if $colors {
		$c : nth($colors, length($colors));
	}

	display: inline-block;
	background: $c;
	width: $size;
	height: $size;
	@if $shape == circle {
		border-radius: 50%;
	}
	animation: #{$a-name}-rotate $a-duration $a-ease 0s infinite;
	position: relative;

	&:after,
	&:before {
		display: block;
		width : $size;
		height: $size/2;
		@if $shape == circle {
			border-radius: $size $size 0 0;
		}
		content:'';
		background: $c;
		transform-origin: $size / 2 $size / 2;
		position: absolute;
		top: 0; left:0;
	}
	&:after {
		animation: #{$a-name}-after $a-duration $a-ease 0s infinite;
		// display: none;
	}
	&:before {
		animation: #{$a-name}-before $a-duration $a-ease 0s infinite;
		// background : white;
	}
	
	$p-delay : 0;
	@if $a-delay > 0 {
		$p-delay : 1 / $a-duration * $a-delay;
	}
	$steps : 2;
	@if $colors {
		$steps : length($colors);
	}

	@keyframes #{$a-name}-after {
		@for $i from 1 through $steps {
			#{percentage(1 / $steps * $i) - 0.0001%} {
				transform : rotateX(180deg);
			}
			#{percentage(1 / $steps * $i)} {
				background: nth($colors, $i);
				transform : rotateX(0deg);
			}
			#{percentage(1 / $steps * $i) - percentage(1 / $steps) / 2} {
				$c : null;
				@if $i - 1 <= 0 {
					$c : nth($colors, length($colors));
				} @else {
					$c : nth($colors, $i - 1);
				}	
				background: s-color($c, -darken 10%);
			}
			#{(percentage(1 / $steps * $i) - percentage(1 / $steps) / 2 + 0.0001%)} {
				$c : null;
				@if $i + 1 > length($colors) {
					$c : nth($colors, 1);
				} @else {
					$c : nth($colors, $i + 1);
				}
				background: s-color(nth($colors, $i), -lighten 8%);
			}
		}
	}
	@keyframes #{$a-name}-before {
		@for $i from 1 through $steps {
			#{percentage(1 / $steps * $i) - 0.0001%} {
				background: nth($colors, $i);
			}
			#{percentage(1 / $steps * $i)} {
				$c : null;
				@if $i + 1 > length($colors) {
					$c : nth($colors, 1);
				} @else {
					$c : nth($colors, $i + 1);
				}
				background: $c;
			}			
		}
	}
	@keyframes #{$a-name}-rotate {
		@for $i from 1 through $steps {
			#{percentage(1 / $steps * $i) - 0.0001%} {
				transform: rotate( ($i - 1) * 90deg);
				$c : null;
				@if $i - 1 <= 0 {
					$c : nth($colors, length($colors));
					background: $c;
				} @else {
					$c : nth($colors, $i - 1);
					background: $c;
				}	
			}
			#{percentage(1 / $steps * $i)} {
				transform: rotate($i * 90deg);
				background: nth($colors, $i);
			}
		}
	}
}